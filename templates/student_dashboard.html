<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Dashboard</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sidebar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
/* GENERAL */
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f5f7fa;
    margin: 0;
    padding: 0;
}
h3, h4 { margin: 0 0 15px 0; }

/* TOP BAR */
.top-bar {
    background: #007bff;
    color: #fff;
    padding: 18px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    margin: 20px;
    border-radius: 12px;
}
.top-bar h2 { font-size: clamp(18px, 4vw, 24px); margin: 0; }
.top-bar-actions { display: flex; gap: 10px; flex-wrap: wrap; }
.top-bar-actions button { 
    padding: 10px 16px; 
    border: none; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: 600; 
    display: inline-flex; 
    align-items: center; 
    gap: 8px; 
    transition: 0.25s;
    min-height: 44px;
}
.top-bar-actions button:hover { opacity: 0.85; transform: translateY(-1px); }
button.logout { background: #dc3545; color: #fff; }
button.danger { background: #ffc107; color: #000; }

/* MAIN LAYOUT */
.main-content {
    display: flex;
    gap: 20px;
    max-width: 1500px;
    margin: 0 auto;
    flex-wrap: wrap;
    padding: 0 20px 20px;
}

/* PROFILE CARD */
.profile-card {
    flex: 0 0 300px;
    background: #fff;
    border-radius: 12px;
    padding: 25px 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    text-align:center;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-height: fit-content;
}
.profile-pic {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #007bff;
    margin-bottom: 15px;
    display: block;
    margin-left: auto;
    margin-right: auto;
}
.profile-card h3 { color: #007bff; margin-bottom: 20px; }

/* UPLOAD PROFILE FORM */
.upload-form {
    display:flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}
.upload-form input[type="file"] { display: none; }
.file-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f0f0f0;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: 0.2s;
}
.file-label:hover { background: #e0e0e0; }

.upload-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}
.upload-btn:hover { background: #218838; transform: translateY(-1px); }

/* PROFILE CARD BUTTONS */
.profile-card button {
    width: 100%;
    margin-top: 8px;
    padding: 10px 0;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: 0.2s;
}
.profile-card button.primary { background: #007bff; color: #fff; }
.profile-card button.primary:hover { background: #0062cc; transform: translateY(-1px); }
.profile-card button.success { background: #28a745; color: #fff; }
.profile-card button.success:hover { background: #218838; transform: translateY(-1px); }

/* TABLE */
.table-container {
    flex: 1 1 auto;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow-x: auto;
    max-height: fit-content;
    align-self: flex-start;
    width: 100%;
}
.table-responsive-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 500px;
}
table th, table td {
    padding: 12px 10px;
    border: 1px solid #e0e0e0;
    text-align: left;
}
table th {
    background: #007bff;
    color: white;
    font-weight: 600;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
}
table tbody tr {
    transition: background-color 0.2s;
}
table tbody tr:hover {
    background-color: #f8f9fa;
}
table tbody tr:nth-child(even) {
    background-color: #fafafa;
}
table tbody tr:nth-child(even):hover {
    background-color: #f0f0f0;
}
.status-used { color: #28a745; font-weight: 600; }
.status-free { color: #dc3545; font-weight: 600; }
.peripheral-status {
    text-align: center;
}

/* FLASH MESSAGES */
.flash-success { color: #28a745; font-weight: 600; margin-bottom: 10px; }
.flash-error { color: #dc3545; font-weight: 600; margin-bottom: 10px; }

/* MODAL */
.modal {
    display: none;
    position: fixed;
    top:0; left:0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal-content {
    background: #fff;
    padding: 30px 25px;
    border-radius: 12px;
    width: 400px;
    max-width: 95%;
    position: relative;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    display:flex;
    flex-direction: column;
    gap: 15px;
}
.modal-content h4 { color: #007bff; font-size: 20px; margin-bottom: 10px; text-align:center; }
.modal-content form { display: flex; flex-direction: column; gap: 0; }
.modal-content form b {
    display: block;
    margin-bottom: 6px;
    font-size: 13px;
    color: #333;
    font-weight: 600;
}
.modal-content input[type="text"],
.modal-content input[type="password"],
.modal-content input[type="email"] {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
    font-size: 14px;
    width: 100%;
    margin-bottom: 0;
    box-sizing: border-box;
}
.modal-content input[type="text"]:disabled,
.modal-content input[type="email"]:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
}
.modal-content button {
    padding: 10px 0;
    border-radius: 8px;
    border:none;
    font-weight:600;
    cursor:pointer;
    transition:0.2s;
}
.modal-content button.primary { background:#007bff; color:white; }
.modal-content button.primary:hover { background:#0062cc; transform:translateY(-1px); }
.modal-content button.success { background:#28a745; color:white; }
.modal-content button.success:hover { background:#218838; transform:translateY(-1px); }

/* MODAL CLOSE BUTTON */
.close { position: absolute; top:12px; right:18px; cursor:pointer; font-size:20px; font-weight:bold; color:#555; }
.close:hover { color:#000; }

/* CROP FIX */
.crop-container {
    width: 100%;
    height: 350px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
}
.crop-container img {
    max-width: 100%;
    max-height: 100%;
}

/* DEVICE INFO CARD STYLING */
.device-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.device-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.device-info-item:last-child {
    border-bottom: none;
}

.device-info-label {
    font-weight: 600;
    opacity: 0.9;
}

.device-info-value {
    font-family: monospace;
    font-size: 13px;
}

/* PERIPHERAL STATUS BADGES */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-badge.connected {
    background: #d4edda;
    color: #155724;
}

.status-badge.unplugged {
    background: #f8d7da;
    color: #721c24;
}

/* RESPONSIVE */
@media (max-width: 900px){
    .main-content { flex-direction: column; align-items: center; gap: 25px; }
    .profile-card { width: 100%; max-width: 100%; }
    .table-container { width: 100%; }
}

@media (max-width: 768px){
    .top-bar {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    .top-bar-actions {
        width: 100%;
    }
    .top-bar-actions button {
        flex: 1;
        justify-content: center;
    }
    .modal-content[style*="width: 700px"] {
        width: 95% !important;
        padding: 20px 15px !important;
    }
    
    .modal-content form > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
    }
    
    .modal-content form > div[style*="display: flex"] > div[style*="flex-shrink: 0"] {
        margin: 0 auto 15px auto;
    }
}
</style>
</head>
<body>
    <!-- Sidebar -->
    {% set current_page = 'student_dashboard' %}
    {% include 'includes/sidebar.html' %}

    <!-- Main Content Wrapper -->
    <div class="main-content-wrapper">
        <!-- Top Bar -->
        {% include 'includes/topbar.html' %}
        {% block topbar_actions %}{% endblock %}

        <!-- Page Content -->
        <div class="page-content">
            <div class="main-content">

    <!-- PROFILE LEFT -->
    <div class="profile-card">
        {% if notifications %}
        <div style="background:#28a745;color:white;padding:12px;border-radius:8px;margin-bottom:15px;font-weight:bold;">
            {% for n in notifications %}
                <div>{{ n["message"] }}</div>
            {% endfor %}
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% set category, msg = messages[-1] %}
            {% if category == 'success' %}
                <p class="flash-success">{{ msg }}</p>
            {% elif category == 'error' %}
                <p class="flash-error">{{ msg }}</p>
            {% else %}
                <p class="flash-{{ category }}">{{ msg }}</p>
            {% endif %}
        {% endif %}
        {% endwith %}

        <h3>{{ student[1] }}</h3>
        <img src="{{ student[6] if student[6] and student[6] != 'None' and student[6] != '' else '/static/default-avatar.jpg' }}" class="profile-pic" onerror="this.onerror=null; if(this.src.indexOf('default-avatar')===-1) this.src='/static/default-avatar.jpg';">
        
        <!-- User Basic Info -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
            {% if student[3] %}
            <div style="margin-bottom: 8px; font-size: 13px; color: #555;">
                <i class="fas fa-graduation-cap" style="color: #007bff; margin-right: 8px;"></i>
                <strong>Grade:</strong> {{ student[3] }}
            </div>
            {% endif %}
            {% if student[4] %}
            <div style="margin-bottom: 8px; font-size: 13px; color: #555;">
                <i class="fas fa-users" style="color: #007bff; margin-right: 8px;"></i>
                <strong>Section:</strong> {{ student[4] }}
            </div>
            {% endif %}
            {% if student[2] %}
            <div style="margin-bottom: 8px; font-size: 13px; color: #555;">
                <i class="fas fa-envelope" style="color: #007bff; margin-right: 8px;"></i>
                <strong>Email:</strong> <span style="word-break: break-all;">{{ student[2] }}</span>
            </div>
            {% endif %}
        </div>

        <!-- Crop Modal -->
        <div id="cropModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('cropModal')">&times;</span>
                <h4>Crop Profile Picture</h4>
                <div class="crop-container">
                    <img id="cropImage" src="">
                </div>
                <button class="success" onclick="getCroppedImage()">Save Cropped Image</button>
            </div>
        </div>

        <button class="success" onclick="openModal('profileModal')" style="margin-top: 15px;"><i class="fas fa-user"></i> View/Edit Profile</button>
        
        <!-- USER ANOMALIES SECTION -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
            <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #333; text-align: left;">
                <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> User Anomalies
            </h4>
            {% if anomalies %}
            <div style="max-height: 200px; overflow-y: auto; overflow-x: hidden; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                    <thead>
                        <tr>
                            <th style="background: #ffc107; color: white; padding: 6px 4px; text-align: left; font-size: 10px; font-weight: 600;">Lab</th>
                            <th style="background: #ffc107; color: white; padding: 6px 4px; text-align: left; font-size: 10px; font-weight: 600;">Device</th>
                            <th style="background: #ffc107; color: white; padding: 6px 4px; text-align: center; font-size: 10px; font-weight: 600;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for anomaly in anomalies[:10] %}
                        <tr style="border-bottom: 1px solid #e0e0e0;">
                            <td style="padding: 6px 4px; font-size: 10px;">{{ anomaly.location or '—' }}</td>
                            <td style="padding: 6px 4px; font-size: 10px;">{{ anomaly.device_name or '—' }}</td>
                            <td style="padding: 6px 4px; text-align: center;">
                                {% if anomaly.deleted == 0 %}
                                    <span style="color: #ffc107; font-weight: 600; font-size: 9px;">Pending</span>
                                {% elif anomaly.deleted == 1 %}
                                    <span style="color: #28a745; font-weight: 600; font-size: 9px;">Cleared</span>
                                {% else %}
                                    <span style="font-size: 9px;">—</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 8px;">
                <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px; color: #28a745;"></i>
                <p style="margin: 0; font-size: 12px; color: #155724; font-weight: 500;">No anomalies detected. All systems operational!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- DEVICE INFO CARD WITH PERIPHERALS -->
    {% if device_info %}
    <div class="table-container" style="flex: 1 1 auto; max-width: 100%; align-self: flex-start;">
        <h4><i class="fas fa-desktop"></i> Current Device</h4>
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); max-height: fit-content;">
            <!-- Device Info Section -->
            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.3);">
                <div style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">
                    <i class="fas fa-desktop"></i> {{ device_info.tag or 'Unknown Device' }}
                </div>
                {% if lab_name %}
                <div style="font-size: 13px; opacity: 0.9;">
                    <i class="fas fa-building"></i> {{ lab_name }}
                </div>
                {% endif %}
            </div>
            
            <!-- Device Details - Compact Grid -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                {% if device_info.hostname %}
                <div>
                    <div style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;"><i class="fas fa-server"></i> Hostname</div>
                    <div style="font-family: monospace; font-size: 12px; background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 6px;">{{ device_info.hostname }}</div>
                </div>
                {% endif %}
                
                {% if device_info.ip_address %}
                <div>
                    <div style="font-size: 11px; opacity: 0.8; margin-bottom: 3px;"><i class="fas fa-globe"></i> IP Address</div>
                    <div style="font-family: monospace; font-size: 12px; background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 6px;">{{ device_info.ip_address }}</div>
                </div>
                {% endif %}
            </div>
            
            <!-- Connected Peripherals Section -->
            <div style="border-top: 1px solid rgba(255,255,255,0.3); padding-top: 15px;">
                <h5 style="margin: 0 0 12px 0; font-size: 16px; opacity: 0.95;">
                    <i class="fas fa-plug"></i> Connected Peripherals
                </h5>
                {% if peripherals %}
                <div id="peripheralsScrollContainer" style="max-height: 250px; overflow-y: auto; overflow-x: hidden; background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; -webkit-overflow-scrolling: touch;">
                    <style>
                        #peripheralsScrollContainer::-webkit-scrollbar {
                            width: 8px;
                        }
                        #peripheralsScrollContainer::-webkit-scrollbar-track {
                            background: rgba(255,255,255,0.1);
                            border-radius: 4px;
                        }
                        #peripheralsScrollContainer::-webkit-scrollbar-thumb {
                            background: rgba(255,255,255,0.4);
                            border-radius: 4px;
                        }
                        #peripheralsScrollContainer::-webkit-scrollbar-thumb:hover {
                            background: rgba(255,255,255,0.6);
                        }
                    </style>
                    <table id="peripheralsTable" style="width: 100%; border-collapse: collapse; color: white;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: left; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Device</th>
                                <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: left; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Brand</th>
                                <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for peripheral in peripherals %}
                            <tr data-unique-id="{{ peripheral.unique_id or '' }}" style="border-bottom: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.05); transition: background 0.2s;">
                                <td style="padding: 8px 6px; font-size: 12px; color: white; font-weight: 500;">{{ peripheral.name or '—' }}</td>
                                <td style="padding: 8px 6px; font-size: 12px; color: rgba(255,255,255,0.95);">{{ peripheral.brand or '—' }}</td>
                                <td class="peripheral-status" style="padding: 8px 6px; text-align: center;">
                                    {% if peripheral.is_unregistered %}
                                        <span style="color: #ffcccb; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-exclamation-triangle"></i> UNREGISTERED</span>
                                    {% elif peripheral.status|lower == 'connected' %}
                                        <span style="color: #90EE90; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Connected</span>
                                    {% elif peripheral.status|lower == 'registered' %}
                                        <span style="color: #90EE90; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Registered</span>
                                    {% elif peripheral.status|lower == 'unplugged' %}
                                        <span style="color: #ffcccb; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-times-circle"></i> Unplugged</span>
                                    {% else %}
                                        <span style="font-size: 10px; color: white; display: inline-flex; align-items: center; gap: 4px;">{{ peripheral.status or '—' }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.7);">
                    <i class="fas fa-plug" style="font-size: 36px; margin-bottom: 10px; opacity: 0.5;"></i>
                    <p style="margin: 0; font-size: 13px;">No peripherals assigned to this device.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

            </div>
        </div>
    </div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content" style="width: 700px; max-width: 95%;">
        <span class="close" onclick="closeModal('profileModal')">&times;</span>
        <h4>Profile Info</h4>
        <form action="/edit_profile" method="POST" enctype="multipart/form-data">
            <!-- Profile Picture Upload - Landscape Layout -->
            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e0e0e0;">
                <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #333;">
                    <i class="fas fa-image"></i> Profile Picture
                </label>
                <div style="display: flex; align-items: flex-start; gap: 20px;">
                    <div style="flex-shrink: 0;">
                        <img src="{{ student[6] if student[6] and student[6] != 'None' and student[6] != '' else '/static/default-avatar.jpg' }}" id="profilePreview" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: #007bff;" onerror="this.onerror=null; if(this.src.indexOf('default-avatar')===-1) { this.src='/static/default-avatar.jpg'; this.style.background='#007bff'; }">
                    </div>
                    <div style="flex: 1;">
                        <input type="file" name="profile_pic" id="profilePicInput" accept="image/*" style="display: none;">
                        <label for="profilePicInput" class="file-label" style="display: inline-flex; align-items: center; gap: 8px; background: #007bff; color: white; padding: 12px 18px; border-radius: 8px; cursor: pointer; font-weight: 500; transition: 0.2s; margin-bottom: 8px;">
                            <i class="fas fa-upload"></i> Choose File
                        </label>
                        <p style="margin: 8px 0 0 0; font-size: 12px; color: #666; line-height: 1.5;">
                            Click to upload a new profile picture. Recommended size: 400x400px. The image will be cropped to a square.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Form Fields - Two Column Layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <b>Id Number :</b>
                    <input type="text" value="{{ student[0] }}" disabled placeholder="ID Number">
                </div>
                <div>
                    <b>Password :</b>
                    <input type="text" value="********" disabled placeholder="Password">
                </div>
                <div>
                    <b>Full Name :</b>
                    <input type="text" name="full_name" value="{{ student[1] }}" placeholder="Full Name" required>
                </div>
                <div>
                    <b>Email :</b>
                    <input type="email" name="email" value="{{ student[2] }}" placeholder="Email" required>
                </div>
                <div>
                    <b>Grade :</b>
                    <input type="text" name="grade" value="{{ student[3] }}" placeholder="Grade" required>
                </div>
                <div>
                    <b>Section :</b>
                    <input type="text" name="section" value="{{ student[4] }}" placeholder="Section" required>
                </div>
                <div style="grid-column: 1 / -1;">
                    <b>Contact Number :</b>
                    <input type="text" name="contact" value="{{ student[5] }}" placeholder="Contact Number">
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                <button type="submit" class="success" style="width: 100%; padding: 12px;">Submit Changes</button>
                <p style="margin-top: 10px; font-size: 12px; color: #555; text-align: center;">
                    <i class="fas fa-info-circle"></i> All edits require admin verification.
                </p>
            </div>
        </form>
    </div>
</div>

<script>
// Flash messages auto-hide
document.addEventListener('DOMContentLoaded', () => {
    const flashMessages = document.querySelectorAll('.flash-success, .flash-error');
    flashMessages.forEach(msg => {
        setTimeout(() => {
            msg.style.transition = 'opacity 0.5s ease-out';
            msg.style.opacity = '0';
            setTimeout(() => msg.remove(), 500);
        }, 5000);
    });
});

// Cropper
let cropper;

// Open modal
function openModal(id, dataUrl) {
    const modal = document.getElementById(id);
    if (!modal) return;

    if (id === 'cropModal') {
        const profilePicInput = document.getElementById('profilePicInput');
        const file = profilePicInput?.files?.[0];
        const image = document.getElementById('cropImage');
        if (!image) {
            console.error('Crop image element missing');
            return;
        }

        const initializeCropper = (src) => {
            image.src = src;
            modal.style.display = 'flex';
            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                autoCropArea: 1,
                responsive: true,
                background: false,
                movable: true,
                zoomable: true
            });
        };

        if (dataUrl) {
            initializeCropper(dataUrl);
        } else if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                initializeCropper(e.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            alert('Please select an image first.');
        }
    } else {
        modal.style.display = 'flex';
    }
}

// Close modal
function closeModal(id) {
    const modal = document.getElementById(id);
    modal.style.display = 'none';

    if (id === 'cropModal' && cropper) {
        cropper.destroy();
        cropper = null;
        document.getElementById('profilePicInput').value = '';
    }
}

// Crop and upload
function getCroppedImage() {
    if (!cropper) return;

    cropper.getCroppedCanvas({
        width: 400,
        height: 400,
        fillColor: '#fff'
    }).toBlob((blob) => {
        const formData = new FormData();
        formData.append('croppedImage', blob, 'profile.png');

        fetch('/upload_cropped_profile', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
               const timestamp = '?t=' + new Date().getTime();
               const profilePic = document.querySelector('.profile-pic');
               const previewImg = document.getElementById('profilePreview');
               
               if (profilePic && data.image_url) {
                   profilePic.src = data.image_url + timestamp;
                   // Prevent error loop
                   profilePic.onerror = function() {
                       this.onerror = null;
                       if (this.src.indexOf('default-avatar') === -1) {
                           this.src = '/static/default-avatar.jpg';
                       }
                   };
               }
               
               if (previewImg && data.image_url) {
                   previewImg.src = data.image_url + timestamp;
                   // Prevent error loop
                   previewImg.onerror = function() {
                       this.onerror = null;
                       if (this.src.indexOf('default-avatar') === -1) {
                           this.src = '/static/default-avatar.jpg';
                           this.style.background = '#007bff';
                       }
                   };
               }
               
               closeModal('cropModal');
            } else {
               alert('Failed to upload cropped image.');
               console.error(data);
            }
        })
        .catch(err => { console.error(err); alert('Upload error'); });
    }, 'image/png');
}

// Preview profile image when file is selected
function previewProfileImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const previewImg = document.getElementById('profilePreview');
            if (previewImg) {
                previewImg.src = e.target.result;
                // Remove error handler temporarily since we're loading from data URL (won't fail)
                previewImg.onerror = null;
            }
            // Open crop modal and pass the preview data URL
            openModal('cropModal', e.target.result);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// File input change - handle from modal
document.addEventListener('DOMContentLoaded', function() {
    const profilePicInput = document.getElementById('profilePicInput');
    if (profilePicInput) {
        profilePicInput.addEventListener('change', function() {
            previewProfileImage(this);
        });
    }
});

// Close modal via close button
document.querySelectorAll('.modal .close').forEach(btn => {
    btn.addEventListener('click', e => {
        const modal = e.target.closest('.modal');
        closeModal(modal.id);
    });
});

// Force logout checker
function checkForceLogout() {
    fetch('/api/check_logout')
        .then(response => response.json())
        .then(data => {
            if (data.force_logout) window.location.href = "/login";
        })
        .catch(err => console.error("Error checking logout:", err));
}
setInterval(checkForceLogout, 5000);

// Peripheral status checker
{% if device_info and device_info.comlab_id and device_info.tag %}
let deviceTag = "{{ device_info.tag }}";
let labId = {{ device_info.comlab_id }};
let statusCheckInterval = null;

let lastRefreshTime = 0;
const REFRESH_INTERVAL = 5000; // Refresh full list every 5 seconds for more responsive updates

function checkPeripheralStatus() {
    // Only check if we're on Windows (device detection requires Windows)
    fetch('/api/check_disconnected_devices', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            pc_tag: deviceTag,
            lab_id: labId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Check if any changes were detected
            const hasChanges = (data.disconnected_count > 0 || data.reconnected_count > 0 || 
                              (data.newly_connected_registered && data.newly_connected_registered.length > 0) ||
                              (data.newly_connected_unregistered && data.newly_connected_unregistered.length > 0) ||
                              data.needs_refresh);
            
            if (hasChanges) {
                // Update status display immediately for disconnected/reconnected devices
                if (data.disconnected_ids && data.disconnected_ids.length > 0 || 
                    data.reconnected_ids && data.reconnected_ids.length > 0) {
                    updatePeripheralStatusDisplay(data.disconnected_ids || [], data.reconnected_ids || []);
                }
                
                // Refresh the entire peripheral list to show all changes including new devices
                setTimeout(() => {
                    refreshPeripheralList();
                }, 500);
            }
            
            // Periodically refresh the full list (every 10 seconds) to catch any other updates
            const now = Date.now();
            if (now - lastRefreshTime >= REFRESH_INTERVAL) {
                refreshPeripheralList();
                lastRefreshTime = now;
            }
        }
    })
    .catch(err => {
        // Silently fail if not Windows or API not available
        console.log("Status check not available (may require Windows):", err.message);
        // Still try to refresh the list periodically in case status was updated elsewhere
        const now = Date.now();
        if (now - lastRefreshTime >= REFRESH_INTERVAL) {
            refreshPeripheralList();
            lastRefreshTime = now;
        }
    });
}

function updatePeripheralStatusDisplay(disconnectedIds, reconnectedIds) {
    // Update status badges in the table dynamically
    disconnectedIds.forEach(uniqueId => {
        const row = document.querySelector(`tr[data-unique-id="${uniqueId}"]`);
        if (row) {
            const statusCell = row.querySelector('.peripheral-status');
            if (statusCell) {
                statusCell.innerHTML = '<span style="color: #ffcccb; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-times-circle"></i> Unplugged</span>';
                // Add visual feedback
                row.style.transition = 'background-color 0.3s';
                row.style.backgroundColor = 'rgba(255,0,0,0.1)';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
        }
    });
    
    reconnectedIds.forEach(uniqueId => {
        const row = document.querySelector(`tr[data-unique-id="${uniqueId}"]`);
        if (row) {
            const statusCell = row.querySelector('.peripheral-status');
            if (statusCell) {
                statusCell.innerHTML = '<span style="color: #90EE90; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Connected</span>';
                // Add visual feedback
                row.style.transition = 'background-color 0.3s';
                row.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
        }
    });
}

// Fetch updated peripheral list from server
async function refreshPeripheralList() {
    if (!deviceTag || !labId) return;
    
    try {
        // Fetch updated peripherals including unregistered devices
        const response = await fetch(`/api/get_peripherals?pc_tag=${encodeURIComponent(deviceTag)}&lab_id=${labId}&include_unregistered=true`);
        const data = await response.json();
        
        if (data.success && data.peripherals !== undefined) {
            // Combine registered and unregistered devices
            const allPeripherals = [...(data.peripherals || []), ...(data.unregistered_devices || [])];
            updatePeripheralTable(allPeripherals);
        }
    } catch (error) {
        // Silently fail - status updates will still work via checkPeripheralStatus
        console.log("Could not refresh peripheral list:", error);
    }
}

function updatePeripheralTable(peripherals) {
    // Find the scroll container - look for the container with max-height
    const scrollContainer = document.querySelector('#peripheralsScrollContainer');
    if (!scrollContainer) {
        // Fallback: try to find by style attribute
        const containers = document.querySelectorAll('div[style*="max-height"]');
        for (let container of containers) {
            if (container.querySelector('#peripheralsTable')) {
                scrollContainer = container;
                break;
            }
        }
    }
    
    if (!scrollContainer) {
        console.log("Could not find peripherals scroll container");
        return;
    }
    
    if (peripherals.length === 0) {
        // Show empty state
        scrollContainer.innerHTML = `
            <div style="text-align: center; padding: 30px; color: rgba(255,255,255,0.9);">
                <i class="fas fa-plug" style="font-size: 36px; margin-bottom: 10px; opacity: 0.7;"></i>
                <p style="margin: 0; font-size: 13px; font-weight: 500;">No peripherals assigned to this device.</p>
            </div>
        `;
        return;
    }
    
    // Ensure table exists
    let table = document.querySelector('#peripheralsTable');
    if (!table) {
        scrollContainer.innerHTML = `
            <table id="peripheralsTable" style="width: 100%; border-collapse: collapse; color: white;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: left; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Device</th>
                        <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: left; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Brand</th>
                        <th style="background: rgba(255,255,255,0.25); padding: 8px 6px; text-align: center; font-size: 11px; font-weight: 600; color: white; border-bottom: 2px solid rgba(255,255,255,0.3);">Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        `;
        table = document.querySelector('#peripheralsTable');
    }
    
    const tbody = table.querySelector('tbody');
    if (!tbody) {
        console.log("Could not find tbody");
        return;
    }
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    // Add rows for each peripheral
    peripherals.forEach(peripheral => {
        const row = document.createElement('tr');
        row.setAttribute('data-unique-id', peripheral.unique_id || '');
        row.style.borderBottom = '1px solid rgba(255,255,255,0.15)';
        row.style.background = 'rgba(255,255,255,0.05)';
        row.style.transition = 'background 0.2s';
        row.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(255,255,255,0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(255,255,255,0.05)';
        });
        
        let statusHtml = '';
        const isUnregistered = peripheral.is_unregistered || false;
        const statusLower = (peripheral.status || '').toLowerCase();
        
        if (isUnregistered) {
            statusHtml = '<span style="color: #ffcccb; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-exclamation-triangle"></i> UNREGISTERED</span>';
        } else if (statusLower === 'connected') {
            statusHtml = '<span style="color: #90EE90; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Connected</span>';
        } else if (statusLower === 'registered') {
            statusHtml = '<span style="color: #90EE90; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Registered</span>';
        } else if (statusLower === 'unplugged') {
            statusHtml = '<span style="color: #ffcccb; font-weight: 600; font-size: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.3); display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-times-circle"></i> Unplugged</span>';
        } else {
            statusHtml = `<span style="font-size: 10px; color: white; display: inline-flex; align-items: center; gap: 4px;">${peripheral.status || '—'}</span>`;
        }
        
        row.innerHTML = `
            <td style="padding: 8px 6px; font-size: 12px; color: white; font-weight: 500;">${peripheral.name || '—'}</td>
            <td style="padding: 8px 6px; font-size: 12px; color: rgba(255,255,255,0.95);">${peripheral.brand || '—'}</td>
            <td class="peripheral-status" style="padding: 8px 6px; text-align: center;">${statusHtml}</td>
        `;
        
        tbody.appendChild(row);
    });
    
}

// Start checking every 3 seconds for faster updates
if (deviceTag && labId) {
    statusCheckInterval = setInterval(checkPeripheralStatus, 3000);
    // Also check immediately and refresh list
    checkPeripheralStatus();
    refreshPeripheralList(); // Initial load
    lastRefreshTime = Date.now();
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
});
{% endif %}

</script>

<script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
<script src="{{ url_for('static', filename='js/topbar-menu.js') }}"></script>
</body>
</html>
